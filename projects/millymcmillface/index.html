<!DOCTYPE html>
<html lang="de-de">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		
		<title>MillyMcMillface</title>
		
		<link rel="stylesheet" href="/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="/css/font-awesome.min.css"/>
		<link rel="stylesheet" href="/css/style.css"/>
		<link rel="stylesheet" href="/css/opensans.css"/>
		<meta name="theme-color" content="#46b71d">
		
	</head>
	<body>
		<a href="https://github.com/reaktor23/website" class="github-corner" aria-label="View source on Github">
  <svg width="80" height="80" viewBox="0 0 250 250" style="fill: #46b71d; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
  </svg>
</a>
<style>
  .github-corner:hover .octo-arm {
    animation:octocat-wave 560ms ease-in-out
  }
  @keyframes octocat-wave {
    0%, 100% { transform:rotate(0) }
    20%, 60% { transform:rotate(-25deg) }
    40%, 80% { transform:rotate(10deg) }
  }
  @media (max-width:500px) {
    .github-corner:hover .octo-arm {
      animation:none
    }
    .github-corner .octo-arm {
      animation:octocat-wave 560ms ease-in-out
    }
  }
</style>

		<div class="container" role="main">
		<header>
	<nav class="navbar navbar-expand-md mb-4 navbar-light">
		<a href="" class="navbar-brand mr-5"><img src="/img/logo.png" alt="Reaktor23 - Hackerspace"></a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav">
				
				
				<li class="nav-item mr-3">
					<a href="/" class="nav-link">Blog</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/about/" class="nav-link">About</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/projects/" class="nav-link">Projects</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/talks/" class="nav-link">Talks</a>
				</li>
				
			</ul>
		</div>
        <div id="reaktorstatus" class="text-center">
            Reaktor status:
            <div id="message" class="text-success"></div>
            <div class="small"><a href="/status/"><i class="fa fa-info-circle" aria-hidden="true"></i></a></div>
        </div>
	</nav>
</header>


		
<article>
    <header>
        <h1 class="headline my-3"><a href="/projects/millymcmillface/">MillyMcMillface</a></h1>
        <div class="meta">
            
            <span class="author">by Valentin, Bouni 
                 - 
            </span>
            
            
            <time datetime="2018-08-22T00:00:00&#43;00:00">2018-08-22</time>
            
        </div>
        <div>
        <div class="project-image-frame">
            <img class="project-image-single" src="DSC_0046.JPG" alt="Project image">
        </div>
        </div>
    </header>
    
    

<h1 id="vorgeschichte">Vorgeschichte</h1>

<p>Es bestand schon lange der Plan, eine CNC Fräse zu bauen, doch das war lange nur ein Plan.
Vor ca. einem Jahr ist die Fräse von Valentin im Zuge von Jugend Forscht gebaut worden.
Leider bereitet das <a href="http://smoothieware.org/smoothieboard">Smoothieboard</a>, das die Fräse steuert, ein paar Probleme.
Deshalb wurde beschlossen, auf eine LinuxCNC basierte Steuerung umzubauen.
Diesen Prozess werden wir hier dokumentieren.</p>

<h1 id="video">Video</h1>


  <div class="">
      <iframe width="640" height="360" src="https://www.youtube.com/embed/DZV8DQtpf2Q" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
  </div>



<h1 id="hardware">Hardware</h1>

<h2 id="elektronik">Elektronik</h2>

<p>Angetrieben werden die Achsen von Nema34 Schrittmotoren. Diese werden von [Treiberkarten]() und 60V Netzteilen mit Strom versorgt. Die <a href="http://cnc.a-ueberbach.de/spindle/alles-ueber-die-22kw-chinaspindel/">Spindel</a> ist über einen Frequenzumrichter des Herstellers HuanYang angeschlossen. Dieser spricht einen kuriosen Modbus-Dialekt. Motoren und Spindel sind bzw. waren an der Steuerung <a href="http://smoothieware.org/smoothieboard">Smoothieboard V1</a> angeschlossen. Hier sind ebenfalls Endschalter angeschlossen. Fräsdateien und Steuerungsinputs bekommt das Board per Ethernet.</p>

<p>Grundsätzlich ist das Smoothieboard eine gute 3D-Drucker-Steuerung, die viele Möglichkeiten bietet. Für den Betrieb an unserer Maschine haben wir allerdings im Laufe der Zeit herausgefunden, dass es noch nicht die optimale Lösung ist. Auf Feedrate-Override oder Nothalt reagiert die Steuerung erst nachdem eine Programmzeile beendet ist.</p>

<p>Wärend das beim Würstchendrucker nicht so schlimm ist, stellt das bei einer etwas seriöseren Maschine ein Sicherheitsrisiko dar und so haben wir uns entschieden, die Steuerung auf ein LinuxCNC-basierendes System umzubauen.</p>

<p>Wir haben uns nach langer Entscheidungszeit für eine <a href="http://store.mesanet.com/index.php?route=product/product&amp;product_id=311">Mesa 7i96</a> FPGA-Karte entschieden da diese via Ethernet mit einem beliebigen PC verbunden werden kann auf dem LinuxCNC läuft. Ausserdem bietet sie alles, was wir benötigen, zum kleinen Preis. Bestellt wurde die Karte bei <a href="http://eusurplus.com">EUsurplus</a>.</p>

<p>Nach den ersten Versuchen stellte sich heraus, dass es sich um ein selten verwendetes Modell handelt und die Konfiguration etwas mehr Arbeit erforderdert, als beispielsweise die größere 7i77. Dennoch haben wir bereits am ersten Abend geschafft, einen Ausgang blinken zu lassen und einen Motor drehen zu lassen. Wie es mit der Steuerung weitergeht, werden wir weiter unten genauer beschreiben.</p>

<h2 id="mechanik">Mechanik</h2>

<p>Ich habe mit meiner Projektarbeit eine Dokumentation erstellt, in denen Details zum Planung und zum Bau der Maschine beschrieben werden. Diese Dokumentation kann <a href="https://github.com/reaktor23/website/raw/master/content/projects/millymcmillface/Seminarkursarbeit_f%C3%BCr_R23.pdf">hier</a> heruntergeladen werden.</p>

<h1 id="umbau-auf-linuxcnc-ein-meisterwerk-in-akten">Umbau auf LinuxCNC - Ein Meisterwerk in ??? Akten</h1>

<h2 id="erster-akt-das-realtime-betriebssystem-installieren">Erster Akt: Das Realtime - Betriebssystem installieren</h2>

<p>Debian Stretch Netinstaller von <a href="https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.6.0-amd64-netinst.iso">hier</a> herunterladen.</p>

<p>Image mit z.B. dd auf einen USB Stick schreiben (Achtung, sichergehen das /dev/sdb auch der USB Stick ist!):</p>

<pre><code>sudo dd if=debian-9.6.0-amd64-netinst.iso of=/dev/sdb bs=4M status=progress
</code></pre>

<p>USB Stick in den Rechner und davon booten, Debian installieren und anschliessend das frisch installierte System booten.</p>

<p>Terminal öffnen und folgende Befehle ausführen:</p>

<pre><code># Als Root anmelden 
su -

# System updaten
apt-get update
apt-get upgrade
apt-get dist-upgrade$

# Realtime kernel installieren
apt-get install linux-image-rt-amd64

# sudo installieren
apt-get install sudo
# User der Gruppe sudo hinzufügen
useradd -a -G sudo &lt;username&gt;

#dirmngr installieren um Fehler beim den Nachfolgenden befehlen zu verhindern
apt-get install dirmngr

# Key des linuxcnc buildbots hinzufügen
apt-key adv --keyserver hkp://keys.gnupg.net --recv-key E0EE663E

# buildbot repo zur sources.list hinzufügen
add-apt-repository &quot;deb http://buildbot.linuxcnc.org/ stretch master-rtpreempt&quot;

# Paketquellen installieren
apt-get update

# linuxcnc installieren
apt-get install linuxcnc-uspace

# Nützliche Pakete installieren
apt-get install vim git

# System neu starten
reboot
</code></pre>

<p>PC neu starten, ein Terminal öffnen und mit <code>uname -a</code> ob der PREEMT RT Kernel geladen wurde.
Da sollte dann so etwas wie <code>Linux mill 4.9.0-8-rt-amd64 #1 SMP PREEMPT RT Debian 4.9.130-2 (2018-10-27) x86_64 GNU/Linux</code> stehen</p>

<h2 id="zweiter-akt-netzwerkverbindung-herstellen">Zweiter Akt: Netzwerkverbindung herstellen</h2>

<p>Die MESA-Karte hat standardmäßig die IP 192.168.1.121 . Um mit der Karte kommunizieren zu können muss am Computer eine statische IP-Adresse vergeben werden. Dazu oben rechts im Panel auf das Netzwerksymbol rechtsklicken und Edit Connections&hellip; auswählen. Im sich öffnenden Fenster eine neue Verbindung erstellen, Èthernet auswählen und bestätigen. Es öffnet sich ein neues Fenster. Im Tab Ethernet wird bei Device die richtige Netzwerkkarte ausgewählt. Im Tab IPv4 Settings wird manual ausgewählt. Mit einem Klick auf Add wird eine Verbindung mit der Adresse 192.168.1.1 und der Netzwaske 24 eingegeben. Der Eintrag des Gateways bleibt leer. Alle Fenster bestätigen und schließen. Nun im Panel oben rechts erneut auf das Netzwerkysmbol klicken und die neu erstellte Verbindung auswählen.</p>

<p>Zum Testen wird ein Terminal geöffnet, in dem der Befehl <code>ping -c 4 191.168.1.1</code> eingegeben wird. Lautet die Antwort <code>4 packets transmitted, 4 received, 0% packet loss</code>, so sollte alles richtig eingestellt sein.</p>

<h2 id="dritter-akt-linuxcnc-einrichten-und-konfiguration">Dritter Akt: LinuxCNC einrichten und Konfiguration</h2>

<p>Die Konfiguration findet über <strong>.ini</strong> und <strong>.hal</strong> files statt. Diese liegen auf unserem Fräsen Rechner unter <code>~/linuxcnc</code> aber im Grunde ist es egal wo man seine config files ablegt, man übergibt den Pfad zum .ini file sowieso beim starten von linuxcnc.</p>

<pre><code># ins home verzeichnis wechseln
cd ~
# Konfig unserer Fräse von Github clonen
git clone https://github.com/reaktor23/MillyMcMillface.git linuxcnc
</code></pre>

<p>Um linuxcnc zu starten ein terminal öffnen und <code>linuxcnc ~/linuxcnc/7i76-1k.ini</code> eingeben und starten.</p>

<p>Da wir doch auch an sehr vielen Stellen unsere Probleme hatten, werden wir versuchen einige davon hier detailierter zu beschreiben.</p>

<h1 id="update-07-01-2019-handrad">Update 07.01.2019 - Handrad</h1>

<p>Wir konten ein gebrauchtes Handrad (<a href="https://www.euchner.de/de-de/Produkte/Handbedienger%C3%A4te-und-Handr%C3%A4der/Handbedienger%C3%A4t-HBA/HBA-079827">Euchner HBA</a>) ergattern und haben dieses währen des <a href="https://events.ccc.de/congress/2018">35C3</a> erfolgreich in unser LinuxCNC Setup integrieren.
Das Handrad verfügt über:</p>

<ul>
<li>2 Wahlschalter, einen Achse, der andere für die Schrittweite</li>
<li>3 Folientasten +, Eilgang, - (derzeit nicht verwendet)</li>
<li>2 Parallel geschaltete Freigabetaster (derzeit nicht verwendet)</li>
<li>1 NOT-STOP Taster</li>
<li>1 Drehencoder</li>
</ul>

<p>Alle Signale wurden auf einem Arduino Nano aufgelegt (<a href="https://github.com/reaktor23/MillyMcMillface/blob/master/handwheel/handwheel_arduino/handwheel_arduino.ino">Link zum Sketch</a>), dieses sendet bei Änderung die daten Seriell zum PC, z.B. Plus:1 für Plustaste ist gedrückt.
Dort liegt ein <a href="https://github.com/reaktor23/MillyMcMillface/blob/master/handwheel/handwheel.py">Python Programm</a> das die Daten auswertet und an Linux CNC weiterreicht <a href="https://github.com/reaktor23/MillyMcMillface/blob/master/handwheel/handwheel.hal">Link zum HAL File</a>.
In der INI muss lediglich das HAL file eingebunden werden <a href="https://github.com/reaktor23/MillyMcMillface/blob/master/7i96-1k.ini#L99">Link zur betreffenden INI Zeile</a></p>

<h1 id="update-17-01-2019-encoder-feedback">Update 17.01.2019 - Encoder Feedback</h1>

<p>Da wir immer wieder mit Schrittverlusten kämpfen haben wir beschlossen die Achsen mit Encodern auszustatten um ein Closed-Loop System zu bekommen.
Unsere Motoren sind glücklicherweise mit beidseiteigen Wellen ausgestattet, die eine treibt die Spindel an, die andere wird mit einem Hohlwellenencoder versehen.
Die Encoder werden an eine Mesanet <a href="http://store.mesanet.com/index.php?route=product/product&amp;product_id=125&amp;search=7i85s">7i85S</a> angeschlossen die uns weitere Encodereingänge verschafft.
Der User PCW aus dem linuxcnc forum war so freundlich uns ein passendes <a href="https://forum.linuxcnc.org/27-driver-boards/35820-7i96-7i85s#123869">Bitfile</a> für die 7i96 zur Verfügung zu stellen.</p>

</article>

		</div>
	<footer>
    <div class="footer-copyright text-center py-3 text-muted">
        <a href="/impressum/" class="text-muted">Impressum / Datenschutz</a>
        <span class="px-2">&bull;</span>
        <a href="https://github.com/reaktor23"><i class="fa fa-github text-muted" style="font-size: 1.25rem;" aria-hidden="true"></i></a>
        <br>
        <span style="font-size: 0.7em;">build time: 2019-02-15 10:50</span>
    </div>
</footer>

	<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/reaktorstatus.js"></script>
<script src="/js/talks.js"></script>

</body>
</html>
