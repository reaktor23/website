<!DOCTYPE html>
<html lang="de-de">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		
		<title>Mate Dealer 3.0</title>
		
		<link rel="stylesheet" href="https://reaktor23.org/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="https://reaktor23.org/css/font-awesome.min.css"/>
		<link rel="stylesheet" href="https://reaktor23.org/css/style.css"/>
		<link rel="stylesheet" href="https://reaktor23.org/css/opensans.css"/>
		<meta name="theme-color" content="#46b71d">
		
	</head>
	<body>
		<a href="https://github.com/reaktor23/website" class="github-corner" aria-label="View source on Github">
  <svg width="80" height="80" viewBox="0 0 250 250" style="fill: #46b71d; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
  </svg>
</a>
<style>
  .github-corner:hover .octo-arm {
    animation:octocat-wave 560ms ease-in-out
  }
  @keyframes octocat-wave {
    0%, 100% { transform:rotate(0) }
    20%, 60% { transform:rotate(-25deg) }
    40%, 80% { transform:rotate(10deg) }
  }
  @media (max-width:500px) {
    .github-corner:hover .octo-arm {
      animation:none
    }
    .github-corner .octo-arm {
      animation:octocat-wave 560ms ease-in-out
    }
  }
</style>

		<div class="container" role="main">
		<header>
	<nav class="navbar navbar-expand-md mb-4 navbar-light">
		<a href="https://reaktor23.org" class="navbar-brand mr-5"><img src="/img/logo.png" alt="Reaktor23 - Hackerspace"></a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav">
				
				
				<li class="nav-item mr-3">
					<a href="/" class="nav-link">Blog</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/about/" class="nav-link">About</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/projects/" class="nav-link">Projects</a>
				</li>
				
				<li class="nav-item mr-3">
					<a href="/talks/" class="nav-link">Talks</a>
				</li>
				
			</ul>
		</div>
        <div id="reaktorstatus" class="text-center">
            Reaktor status:
            <div id="message" class="text-success"></div>
            <div class="small"><a href="/status/"><i class="fa fa-info-circle" aria-hidden="true"></i></a></div>
        </div>
	</nav>
</header>


		
<article>
    <header>
        <h1 class="headline my-3"><a href="https://reaktor23.org/projects/matedealer3/">Mate Dealer 3.0</a></h1>
        <div class="meta">
            
            <span class="author">by Bouni 
                 - 
            </span>
            
            
            <time datetime="2019-10-24">2019-10-24</time>
            
        </div>
        <div>
        <div class="project-image-frame">
            <img class="project-image-single" src="kicad-matedealer-3.png" alt="Project image">
        </div>
        </div>
    </header>
    
    <aside class="panel panel-default">
        <div class="panel-heading">Table Of Conent</div>
        <div class="panel-body">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#features">Features</a></li>
    <li><a href="#pictures">Pictures</a></li>
    <li><a href="#the-procedure-of-getting-a-cool-drink">The procedure of getting a cool drink</a></li>
    <li><a href="#the-payment">The payment</a></li>
    <li><a href="#what-works-so-far">What works so far</a>
      <ul>
        <li><a href="#nfc-authentication">NFC authentication</a></li>
        <li><a href="#cooler">Cooler</a></li>
        <li><a href="#display">Display</a></li>
        <li><a href="#accounting">Accounting</a></li>
        <li><a href="#logging">Logging</a></li>
        <li><a href="#integration">Integration</a></li>
      </ul>
    </li>
    <li><a href="#fails">Fails</a></li>
  </ul>
</nav>
        </div>
    </aside>
    
    <h1 id="the-background">The background</h1>
<p>It all started with <a href="/projects/matedealer/">MateDealer 1.0</a> with all its original electronics extended by an MDB implementation.
The controller died for some unknown reason and the MateDealer sat there in an pitiful state for a quite long time.</p>
<p>Then we decided to build our own new controller board based on an <a href="https://store.arduino.cc/arduino-mega-2560-rev3">Arduino Mega2560</a> and an <a href="https://www.pcengines.ch/alix3d3.htm">Alix 3d3</a>.
<a href="https://reaktor23.org/projects/matedealer2/">MateDealer 2.0</a> was born. This itteration never took of as we had problems getting the communication between the Arduino and the PC working flawlessly.</p>
<p>Again the MateDealer was out of order for a couple of years, until we decided to take a third attempt to get it up and running.
Here&rsquo;s what we came up with!</p>
<h1 id="matedealer-30">MateDealer 3.0</h1>
<h2 id="features">Features</h2>
<ul>
<li>Based on a <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b-plus/">RaspberryPi 3B+</a></li>
<li>Custom Hat designed to fit our machine (might work for yours as well)</li>
<li>24VAC powered</li>
<li>Bridge rectifier for ~22VDC</li>
<li>DC-DC StepDown converter for 5VDC</li>
<li><a href="https://www.acs.com.hk/en/products/3/acr122u-usb-nfc-reader/">NFC Reader</a> for authentication</li>
<li>Control for 5 slot motors via relays</li>
<li>TR5 fuses to protect the moters in case of a jam</li>
<li>Control for the cooler via another relay</li>
<li>5 inputs for motor home position switches</li>
<li>5 inputs for slot empty switches</li>
<li>5 inputs for product selection buttons</li>
<li>LED&rsquo;s for every output and input</li>
<li>1-Wire port for temperature measurement</li>
<li>I2C port for later addons</li>
</ul>
<h2 id="pictures">Pictures</h2>
<p>The HAT in all its beauty


<div><a href="/projects/matedealer3/matedealer-3-1.jpg"><img src="/projects/matedealer3/matedealer-3-1_huceefb836f85cf65b07c7901273edd316_1439485_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>The HAT stacked on top of the RaspberryPi and mounted to the inside of the machine using M2.5x12mm distance bolts


<div><a href="/projects/matedealer3/matedealer-3-2.jpg"><img src="/projects/matedealer3/matedealer-3-2_hu2dfb4bf922867927801c11833d0f53bd_4773924_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>The wiring of the product selection buttons


<div><a href="/projects/matedealer3/matedealer-3-3.jpg"><img src="/projects/matedealer3/matedealer-3-3_hu9f748c08d999e671a7424e798f8436ad_3055653_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>The wiring of the motors, the home postion switches and the slot empty switches


<div><a href="/projects/matedealer3/matedealer-3-4.jpg"><img src="/projects/matedealer3/matedealer-3-4_hub1a495a07e3039d5df8762794a093931_3791493_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>A close up of the motor wiring


<div><a href="/projects/matedealer3/matedealer-3-5.jpg"><img src="/projects/matedealer3/matedealer-3-5_hu050fbb6ca46e1dec8548c8f66ac28a33_3497546_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>The 1-wire temperature sensor


<div><a href="/projects/matedealer3/matedealer-3-6.jpg"><img src="/projects/matedealer3/matedealer-3-6_hu527f9576b3ca85f4a4f56aef40289d51_3758654_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<p>The external relay that switches the cooler


<div><a href="/projects/matedealer3/matedealer-3-7.jpg"><img src="/projects/matedealer3/matedealer-3-7_hu46882ea6be37361fd3d71c1dee5d12f2_2820066_600x0_resize_q80_lanczos.jpg" class="img-thumbnail " width="600"></a></div>
</p>
<h2 id="the-procedure-of-getting-a-cool-drink">The procedure of getting a cool drink</h2>
<ol>
<li>The person approaches the machine and swipes a NFC Tag</li>
<li>The reader beeps, signaling the person that its ready</li>
<li>The person selects a drink via one of the 5 buttons at the front</li>
<li>The machine dispenses the selected bottle from the slot</li>
<li>The machine writes <code>user_id</code>, <code>timestamp</code> and <code>product_id</code> to a influx db that runs on actse<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>Happy person consumes the drink</li>
</ol>
<h2 id="the-payment">The payment</h2>
<p>Once every month a script runs on <code>actse</code> calculating the amount a person has to pay depending on the number of consumed drinks an the costs.
That makes it easy for us to get the money and does not need to handle payments on every vend.</p>
<h2 id="what-works-so-far">What works so far</h2>
<p>We are in a beta phase at the moment.</p>
<h3 id="nfc-authentication">NFC authentication</h3>
<p>We finally managed to integrate a ACR-122U USB NFC Reader with the MateDealer that allows us to authenticate a user. We know for sure that using the UID of a NFC badge isn&rsquo;t very secure but thats not the point for us.</p>
<h3 id="cooler">Cooler</h3>
<p>The cooler is controlled depending on the temperature inside of the machine with a hysteresis that is configurable.
That allows us to only coll down when its neccessary.
The cooler is blocked when nobody is in the hackerspace to save energy or it is not Tuesday between 18:00 and 23:00 which is our main opening hours.</p>
<h3 id="display">Display</h3>
<p>We ordered a 8&rdquo; HDMI display on AliExpress that will replace the product lables next to the selection buttons.
That way we can shwo dynamic product labels an when a vend is ongoing or another information needs to be shown to the users it can be done that way.</p>
<h3 id="accounting">Accounting</h3>
<p>We decided to send a measurement to a InfluxDB on every vend that includes <code>username</code>, <code>product</code>, <code>price</code> and a <code>timestamp</code>.
At the end of the month, we can simply run a (yet to be written) script that fetchs all vend of the past month and sums up the consumption per user.
Our treasurer then can request the amount from the user. We plan to have users to top up a virtual account and the the treasurer wil subtract the amount from the available funds.
That way he does not have to run after people an make them pay afterwards.
We will see how that works out.</p>
<h3 id="logging">Logging</h3>
<p>We send several values to the InfluxDB to have a log of what is going on, at the moment these are:</p>
<ul>
<li>Inside temperature</li>
<li>Cooler state (on/off)</li>
<li>Slot states (ok/empty)</li>
</ul>
<h3 id="integration">Integration</h3>
<p>Our <a href="https://reaktor23.org/projects/pwrcmdr2/">pwrCMDer</a> runs <a href="https://www.home-assistant.io/">Home-Assistant</a>, from there we&rsquo;ve integrated several InfluxDB values as sensors.
That allows us to let the pwrCMDer react to state changes.
We plan to let it send a information message when a slot runs empty for example (yet to be done) or having the states in our <a href="https://reaktor23.org/status/">SpaceAPI</a> (already done)</p>
<h2 id="fails">Fails</h2>
<ul>
<li>I didn&rsquo;t know how much current the motors draw, so I guessed 1A and ordered TR5 fuses with 1A. Turns out the are labled with 5.2A and actually draw 4.9A which on the first try blew all 5 fuses imedialtely.</li>
<li>I used relays that are rated for 3A because I guessed the actual motor current (and I had dozens of them laying around). I decided to use them directly until they start to fail. If that happens I replace them and use additional relays that are controlled by the small ones.</li>
<li>I accidentally placed a via that stitches 24VAC to GND which results in a short circuit when one of the relays is switched on. This issue could be easily fixed with a sharp cutter knife.</li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Our main server, actse = a computer that serves everything <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

</article>

		</div>
	<footer>
	<div class="footer-copyright text-center py-3 text-muted">
		<a href="/impressum/" class="text-muted">Impressum / Datenschutz</a>
		
		<span class="px-2">&bull;</span>
		<a href="https://github.com/reaktor23"><i class="fa fa-github text-muted" style="font-size: 1.25rem;" aria-hidden="true"></i></a>
		<br>
		<span style="font-size: 0.7em;">build time: 2020-04-21 19:22 UTC</span>
	</div>
</footer>

	<script src="https://reaktor23.org/js/jquery.min.js"></script>
<script src="https://reaktor23.org/js/showdown.min.js"></script>
<script src="https://reaktor23.org/js/bootstrap.min.js"></script>
<script src="https://reaktor23.org/js/reaktorstatus.js"></script>
<script src="https://reaktor23.org/js/talks.js"></script>

</body>
</html>
